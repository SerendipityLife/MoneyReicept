import{Ea as m,b as f,d as r,g as u,h as g,i as d,k as S,n as y,p as o,r as A,t as O}from"./chunk-TEVF6OOM.js";import{a as c,b as p,e as h}from"./chunk-JHI3MBHO.js";var E=(()=>{let s=class s{constructor(e){this.http=e,this.STORAGE_KEY="offline-data",this.PENDING_ACTIONS_KEY="pending-actions",this.SYNC_STATUS_KEY="sync-status",this.isOnlineSubject=new f(navigator.onLine),this.syncStatusSubject=new f({isOnline:navigator.onLine,lastSync:null,pendingActions:0,syncInProgress:!1,syncError:null}),this.isOnline$=this.isOnlineSubject.asObservable(),this.syncStatus$=this.syncStatusSubject.asObservable(),this.pendingActions=[],this.offlineData=null,this.initializeOfflineSupport(),this.loadOfflineData(),this.loadPendingActions(),this.setupNetworkListeners()}initializeOfflineSupport(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered successfully:",e)},e=>{console.log("Service Worker registration failed:",e)})}setupNetworkListeners(){let e=g(window,"online").pipe(u(()=>!0)),t=g(window,"offline").pipe(u(()=>!1));d(e,t).pipe(y(navigator.onLine),S(),o(i=>{this.isOnlineSubject.next(i),this.updateSyncStatus({isOnline:i}),i&&this.syncPendingActions()})).subscribe()}loadOfflineData(){let e=localStorage.getItem(this.STORAGE_KEY);if(e)try{this.offlineData=JSON.parse(e)}catch(t){console.error("Error loading offline data:",t)}}saveOfflineData(){this.offlineData&&localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.offlineData))}loadPendingActions(){let e=localStorage.getItem(this.PENDING_ACTIONS_KEY);if(e)try{this.pendingActions=JSON.parse(e),this.updateSyncStatus({pendingActions:this.pendingActions.length})}catch(t){console.error("Error loading pending actions:",t)}}savePendingActions(){localStorage.setItem(this.PENDING_ACTIONS_KEY,JSON.stringify(this.pendingActions)),this.updateSyncStatus({pendingActions:this.pendingActions.length})}updateSyncStatus(e){let t=this.syncStatusSubject.value;this.syncStatusSubject.next(c(c({},t),e))}isOnline(){return this.isOnlineSubject.value}getSyncStatus(){return this.syncStatusSubject.value}storeOfflineData(e,t){this.offlineData||(this.offlineData={receipts:[],receiptItems:[],settings:null,lastSync:new Date}),this.offlineData[e]=t,this.offlineData.lastSync=new Date,this.saveOfflineData()}getOfflineData(e){return this.offlineData?this.offlineData[e]:null}clearOfflineData(){this.offlineData=null,localStorage.removeItem(this.STORAGE_KEY)}addPendingAction(e){let t=p(c({},e),{id:this.generateId(),timestamp:new Date,retryCount:0});this.pendingActions.push(t),this.savePendingActions()}removePendingAction(e){this.pendingActions=this.pendingActions.filter(t=>t.id!==e),this.savePendingActions()}getPendingActions(){return[...this.pendingActions]}clearPendingActions(){this.pendingActions=[],this.savePendingActions()}syncPendingActions(){return h(this,null,function*(){if(!this.isOnline()||this.pendingActions.length===0)return;this.updateSyncStatus({syncInProgress:!0,syncError:null});let e=[...this.pendingActions],t=0,i=0;for(let n of e)try{yield this.executeAction(n),this.removePendingAction(n.id),t++}catch(a){console.error("Error syncing action:",a),n.retryCount++,n.retryCount>=3&&this.removePendingAction(n.id),i++}this.updateSyncStatus({syncInProgress:!1,lastSync:new Date,syncError:i>0?`${i} actions failed to sync`:null}),this.savePendingActions()})}executeAction(e){return h(this,null,function*(){switch(e.type){case"upload":return this.http.post(e.endpoint,e.data).toPromise();case"update":return this.http.put(e.endpoint,e.data).toPromise();case"delete":return this.http.delete(e.endpoint).toPromise();default:throw new Error(`Unknown action type: ${e.type}`)}})}offlinePost(e,t){return this.isOnline()?this.http.post(e,t).pipe(o(()=>{this.updateOfflineCache(e,t)})):(this.addPendingAction({type:"upload",endpoint:e,data:t}),r({success:!0,offline:!0,data:t}))}offlinePut(e,t){return this.isOnline()?this.http.put(e,t).pipe(o(()=>{this.updateOfflineCache(e,t)})):(this.addPendingAction({type:"update",endpoint:e,data:t}),r({success:!0,offline:!0,data:t}))}offlineDelete(e){return this.isOnline()?this.http.delete(e).pipe(o(()=>{this.removeFromOfflineCache(e)})):(this.addPendingAction({type:"delete",endpoint:e,data:null}),r({success:!0,offline:!0}))}offlineGet(e,t){if(this.isOnline())return this.http.get(e).pipe(o(i=>{this.cacheGetResponse(e,i)}));{let i=this.getCachedResponse(e);return i?r(i):t?r(t):r({error:"No cached data available",offline:!0})}}updateOfflineCache(e,t){if(e.includes("/receipts")){let i=this.getOfflineData("receipts")||[];i.push(t),this.storeOfflineData("receipts",i)}}removeFromOfflineCache(e){if(e.includes("/receipts/")){let t=e.split("/").pop(),n=(this.getOfflineData("receipts")||[]).filter(a=>a.id!==t);this.storeOfflineData("receipts",n)}}cacheGetResponse(e,t){let i=`cache-${e}`;localStorage.setItem(i,JSON.stringify({data:t,timestamp:new Date().toISOString()}))}getCachedResponse(e){let t=`cache-${e}`,i=localStorage.getItem(t);if(i)try{let n=JSON.parse(i);if(Date.now()-new Date(n.timestamp).getTime()<24*60*60*1e3)return n.data}catch(n){console.error("Error parsing cached response:",n)}return null}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}getStorageUsage(){"storage"in navigator&&"estimate"in navigator.storage&&navigator.storage.estimate().then(t=>({used:t.usage||0,available:t.quota||0}));let e=0;for(let t in localStorage)localStorage.hasOwnProperty(t)&&(e+=localStorage[t].length);return{used:e*2,available:5*1024*1024}}clearCache(){Object.keys(localStorage).forEach(t=>{t.startsWith("cache-")&&localStorage.removeItem(t)})}getNetworkQuality(){if("connection"in navigator){let e=navigator.connection;if(e.effectiveType)return["slow-2g","2g"].includes(e.effectiveType)?"slow":"fast"}return"unknown"}};s.\u0275fac=function(t){return new(t||s)(O(m))},s.\u0275prov=A({token:s,factory:s.\u0275fac,providedIn:"root"});let l=s;return l})();export{E as a};
